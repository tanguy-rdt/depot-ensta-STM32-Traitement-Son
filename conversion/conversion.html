<!DOCTYPE HTML>
<html lang="fr" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Conversion du PDM → PCM - Project SA4 STM32 - Traitement du son</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../presentation/presentation.html"><strong aria-hidden="true">1.</strong> Présentation</a></li><li class="chapter-item expanded "><a href="../acquisition/acquisition.html"><strong aria-hidden="true">2.</strong> Acquisition des données PDM</a></li><li class="chapter-item expanded "><a href="../conversion/conversion.html" class="active"><strong aria-hidden="true">3.</strong> Conversion du PDM → PCM</a></li><li class="chapter-item expanded "><a href="../diffusion/diffusion.html"><strong aria-hidden="true">4.</strong> Diffusion des données PCM</a></li><li class="chapter-item expanded "><a href="../filtrage/filtrage.html"><strong aria-hidden="true">5.</strong> Filtrage</a></li><li class="chapter-item expanded "><a href="../exemple/exemple.html"><strong aria-hidden="true">6.</strong> Exemple</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../exemple/toggle_led/toggle_led.html"><strong aria-hidden="true">6.1.</strong> Toggle Led</a></li><li class="chapter-item expanded "><a href="../exemple/pushbutton_led/pushbutton_led.html"><strong aria-hidden="true">6.2.</strong> Pushbutton Led</a></li><li class="chapter-item expanded "><a href="../exemple/pushbutton_uart/pushbutton_uart.html"><strong aria-hidden="true">6.3.</strong> Pushbutton UART</a></li><li class="chapter-item expanded "><a href="../exemple/wave_gen_sinus/wave_gen_sinus.html"><strong aria-hidden="true">6.4.</strong> Sinus generator</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Project SA4 STM32 - Traitement du son</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://gitlab.ensta-bretagne.fr/roudauta/depot-STM32-Traitement-Son" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-gitlab"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="conversion-des-données-pdm--pcm"><a class="header" href="#conversion-des-données-pdm--pcm">Conversion des données <em>PDM</em> → <em>PCM</em></a></h1>
<h2 id="le-pcm"><a class="header" href="#le-pcm">Le PCM</a></h2>
<p>Le <em>PCM</em> (<em>Pulse Code With Modulation</em>), est un signal numérique produit à la suite d’une chaîne d’opération : Échantillonnage, quantification et codage. <br />
Comme on peut le constater sur la figure suivante le signal est échantillonné à une fréquence <em>fe</em> et chaque échantillon représente une impulsion à une certaine amplitude.</p>
<p><img src="./img/pcm.png" alt="" /></p>
<p>Si l’on compare l’allure d’un signal <em>PDM</em> à celle d’un signal <em>PCM</em>, on remarque 2 différences principales :</p>
<ol>
<li>La fréquence d’échantillonnage du signal <em>PDM</em> est plus importante que celle du signal <em>PCM</em></li>
<li>Le signal <em>PDM</em> possède des amplitudes binaires (0-1) alors que l’amplitude du <em>PCM</em> est numérique.</li>
</ol>
<p><img src="./img/pdm_pcm.png" alt="" /></p>
<h1 id="conversion"><a class="header" href="#conversion">Conversion</a></h1>
<h2 id="conversion-selon-stm"><a class="header" href="#conversion-selon-stm">Conversion selon STM</a></h2>
<p>Il existe plusieurs solutions, pour réaliser une conversion <em>PDM</em> vers <em>PCM</em>. Selon la documentation de <em>STM32</em> il est conseillé de suivre la procédure suivante :</p>
<p><img src="./img/conversion.png" alt="" /></p>
<p>Il faut dans un premier temps utiliser un filtre passe-bas pour convertir les données <em>PDM</em> en <em>PCM</em>. La conversion se fait grâce à un filtre <em>FIR</em>, l’objectif est de multiplier les 
échantillons <em>PDM</em> par les coefficients du filtre et de faire une somme pondérée. Au final on se retrouve avec des données numériques, c’est-à-dire un signal <em>PCM</em></p>
<p><img src="./img/fir.png" alt="" /></p>
<p>Ce filtre permet également de réduire la fréquence d’échantillonnage, mais potentiellement de manière insuffisente. Pour obtenir la fréquence d’échantillonnage adapté du <em>PCM</em> il faut procéder à une décimation, avec un facteur de décimation approprié.</p>
<p><img src="./img/d%C3%A9cimation.png" alt="" /></p>
<h2 id="notre-conversion"><a class="header" href="#notre-conversion">Notre conversion</a></h2>
<p>Dans le cas du projet, nous avons simplifié la conversion. Nous allons simplement réaliser une décimation. Une décimation tout de même un peu particulière puisqu’en plus de décimer notre signal, on va convertir nos bits en données numériques, c’est-à-dire en <em>PCM</em>.</p>
<p><img src="./img/conversion2.png" alt="" /></p>
<p>Comme expliqué précédemment, le <em>PDM</em> est configuré à une fréquence d’échantillonnage de <em>3,072 MHz</em>, ce qui est beaucoup plus important que la fréquence cible du <em>PCM</em> qui est de <em>48 kHz</em>. L’objectif est donc de réduire la fréquence du signal <em>PDM</em>. <br />
La décimation permet de réduire la fréquence d’échantillonnage d’un signal en prenant seulement un échantillon tous les n-échantillons : </p>
<p><img src="./img/d%C3%A9cimation.png" alt="" /></p>
<p>C’est donc idéal pour notre cas d’utilisation. <br />
Pour déterminer le facteur de décimation on peut appliquer la formule de la figure précédente. Après calcul on trouve un facteur de décimation de 64. Si on prend donc 1 échantillon <em>PDM</em> tout les 64 échantillons, on obtiendra un signal avec une fréquence de <em>48 kHz</em>. <br />
Seulement, prendre 1 échantillon tous les n-échantillons, permet uniquement de réduire la fréquence d’échantillonnage du signal, pas de convertir en <em>PDM</em> → <em>PCM</em>. On va donc compter tous les bits à 1 dans une trame de 64 bits, ce qui nous permettra d’obtenir une valeur entre 0 et 64. 
Au final on obtiendra un signal <em>PCM</em> avec un certain nombre d’impulsions, des amplitudes situées entre 0 et 64 avec une fréquence d’échantillonnage de <em>48 kHz</em>.</p>
<p><img src="./img/decimation2.png" alt="" /></p>
<h2 id="mise-en-pratique"><a class="header" href="#mise-en-pratique">Mise en pratique</a></h2>
<h3 id="variables"><a class="header" href="#variables">Variables</a></h3>
<p>Nous avons besoin d’un certain nombre de variables. </p>
<ol>
<li>Le <code>pdmBuffer</code> présentê à la partie précédente qui contient les valeurs <em>PDM</em> du <em>DMA</em></li>
<li>Le <code>pcmBuffer</code>, il contiendra les données <em>PCM</em> converties d’un demi <em>DMA</em> </li>
<li>Le <code>pcmData</code>, il contiendra toutes les données <em>PCM</em> converties. </li>
</ol>
<pre><code class="language-c">#define NB_FRAME_IN_PDM_BUFFERSIZE 20
#define PDM_BUFFERSIZE PDM_NB_SAMBLE_BY_FRAME*NB_FRAME_IN_PDM_BUFFERSIZE
#define PCM_BUFFERSIZE NB_FRAME_IN_PDM_BUFFERSIZE/2

#define PCM_SAMPLING_RATE 48000
#define NB_SEC_OUTPUT 1
#define PCM_NB_SAMPLE (NB_SEC_OUTPUT*PCM_SAMPLING_RATE)

uint8_t pdmBuffer[PDM_BUFFERSIZE];
uint32_t pcmBuffer[PCM_BUFFERSIZE];
uint32_t pcmData[PCM_NB_SAMPLE];
</code></pre>
<h3 id="lecture-du-dma"><a class="header" href="#lecture-du-dma">Lecture du DMA</a></h3>
<p>Comme expliqué dans la partie de <a href="../acquisition/acquisition.html">l’acquisition</a>, nous travaillons en demi <em>DMA</em> pour des soucis de stockage et de conversion en temps réel. Quand un demi <em>DMA</em> est plein, les données <em>PDM</em> sont disponibles pour être converties en <em>PCM</em>. <br />
Il faut donc savoir qu’elle partit du <em>DMA</em> est plein pour procédé à la conversion. </p>
<p>STM nous donne accès à deux fonctions d’interruptions que l’on peut modifier pour mettre des flags à 1.</p>
<ol>
<li>Une interruption pour déterminer si la moitié du <em>DMA</em> est plein : <br />
<code>void HAL_SAI_RxHalfCpltCallback(SAI_HandleTypeDef *hsai)</code></li>
<li>Une interruption pour déterminer si le <em>DMA</em> est plein : <br />
<code>void HAL_SAI_RxCpltCallback(SAI_HandleTypeDef *hsai)</code></li>
</ol>
<p>Par exemple si on utilise c’est fonctions d’interruptions avec deux flags, <code>cplt</code> et <code>half</code>. Si <code>half</code> vaut 1 alors la première moitié du <em>DMA</em> est prête, si c’est <code>cplt</code> dans ce cas c’est la seconde. </p>
<pre><code class="language-c">void HAL_SAI_RxCpltCallback(SAI_HandleTypeDef *hsai){
	cplt = 1;
	half = 1;
}

void HAL_SAI_RxHalfCpltCallback(SAI_HandleTypeDef *hsai){
	cplt = 0;
	half = 1;
}

</code></pre>
<p>Maintenant qu’on à des flags il ne reste plus qu’à les utiliser pour réaliser le traitement. Si <code>half</code> vaut 1 alors on commence le traitement, si <code>cplt</code> vaut 0 alors on prend la première moitié sinon la seconde.</p>
<pre><code class="language-c">while (recording){
	if(half){
		half = 0;
		pdm2pcm((uint8_t*)(pdmBuffer+cplt*(PDM_BUFFERSIZE/2)), pcmData);
	}
}
</code></pre>
<p>Chaque interruption on exécute la fonction de conversion <code>pcm2pdm</code> avec en premier argument les données <em>PDM</em> (données dans le DMA) à convertir et en deuxième argument un tableau contenant les données <em>PCM</em> convertis. <br />
C’est dans le premier argument, où l’on donne le tableau des valeurs <em>pdm</em> qu’il faut spécifier sur qu’elle moitié du <em>DMA</em> on va travaillé. </p>
<ol>
<li>Si c’est la première moitié, il suffit de lui donner le tableau <code>pdmBuffer</code> en entier. C’est-à-dire que si notre tableau est de longueur 100, alors on commence à l’élément 0 et dans notre fonction on ira jusqu’à l’élément 49. </li>
<li>Si c’est la seconde moitié, alors on donne le tableau <code>pdmBuffer+PDM_BUFFERSIZE/2</code>, c’est-à-dire que si notre tableau est de longueur 100, alors on commence à l’élément 50 et dans notre fonction on ira jusqu’à l’élément 99. </li>
</ol>
<h3 id="conversion-des-données"><a class="header" href="#conversion-des-données">Conversion des données</a></h3>
<p>Il est important de noter que dans la partie <a href="../acquisition/acquisition.html">acquisition</a>, nous avons configuré le <em>SAI</em> avec une longueur de frame de 64 bits et un type de données sur 8 bits. Nos valeurs dans le <em>DMA</em> sont donc sur 8 bits. Nous on souhaite faire la somme du nombre de bit à 1 dans une frame (64-bits), pour cela on va créer un pointeur sur 64 bits vers notre tableau de 8 bits qui contient les données <em>PDM</em>: <code>uint64_t* pdmFrameBuffer = pdmBuffer;</code> 
Maintenant que l’on a un pointeur de 64-bits sur notre tableau de 8-bits, on peut parcourir tous les frames de notre acquisition à l’ai d’une boucle <code>for</code>. </p>
<p>Pour compter les bits à 1 on utilise une fonction intégrée au compilateur: <code>__builtin_popcount</code>, cela nous permet donc d’obtenir une valeur entre 0 et 64. Chaque frame de 8 échantillons <em>PDM</em> se retrouve réduit à 1 échantillon <em>PCM</em>. <br />
Il ne faut pas oublier que c'est échantillons sont ajoutés au tableau contenant la totalité des échantillons <em>PCM</em>.</p>
<pre><code class="language-c">void pdm2pcm(uint8_t* pdmBuffer, uint32_t* pcmData){
	uint64_t* pdmFrameBuffer = pdmBuffer;

	for (int frameNbr=0; frameNbr&lt;NB_FRAME_IN_PDM_BUFFERSIZE/2; frameNbr++){
		pcmData[pcmDataIndex++] = (uint32_t)__builtin_popcount(pdmFrameBuffer[frameNbr]);
	}
}
</code></pre>
<h3 id="arrêt-de-lenregistrement"><a class="header" href="#arrêt-de-lenregistrement">Arrêt de l’enregistrement</a></h3>
<p>Les données d’un demi <em>DMA</em> sont maintenant convertissables à l’aide de notre fonction, mais il reste un problème. On à un tableau <code>pcmData</code> qui à une longueur de 48 000 échantillons, soit 1 seconde d’enregistrement avec une fréquence d’échantillonnage de 48 kHz. Si <code>pcmData</code> est plein, dans ce cas il faut pouvoir arrêter l’enregistrement.</p>
<p>Ce qui nous permet d’avoir le code suivant :</p>
<pre><code class="language-c">while (recording){
	if(half){
		half = 0;
		pdm2pcm((uint8_t*)(pdmBuffer+cplt*(PDM_BUFFERSIZE/2)), pcmData);

		if(pcmDataIndex &gt;= PCM_NB_SAMPLE){
			recording = 0;
			HAL_SAI_DMAStop(&amp;hsai_BlockA1);
		}
	}
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../acquisition/acquisition.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../diffusion/diffusion.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../acquisition/acquisition.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../diffusion/diffusion.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </div>
    </body>
</html>
