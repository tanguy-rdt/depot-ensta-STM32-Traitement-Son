<!DOCTYPE HTML>
<html lang="fr" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Filtrage - Project SA4 STM32 - Traitement du son</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../presentation/presentation.html"><strong aria-hidden="true">1.</strong> Présentation</a></li><li class="chapter-item expanded "><a href="../acquisition/acquisition.html"><strong aria-hidden="true">2.</strong> Acquisition des données PDM</a></li><li class="chapter-item expanded "><a href="../conversion/conversion.html"><strong aria-hidden="true">3.</strong> Conversion du PDM → PCM</a></li><li class="chapter-item expanded "><a href="../diffusion/diffusion.html"><strong aria-hidden="true">4.</strong> Diffusion des données PCM</a></li><li class="chapter-item expanded "><a href="../filtrage/filtrage.html" class="active"><strong aria-hidden="true">5.</strong> Filtrage</a></li><li class="chapter-item expanded "><a href="../exemple/exemple.html"><strong aria-hidden="true">6.</strong> Exemple</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../exemple/toggle_led/toggle_led.html"><strong aria-hidden="true">6.1.</strong> Toggle Led</a></li><li class="chapter-item expanded "><a href="../exemple/pushbutton_led/pushbutton_led.html"><strong aria-hidden="true">6.2.</strong> Pushbutton Led</a></li><li class="chapter-item expanded "><a href="../exemple/pushbutton_uart/pushbutton_uart.html"><strong aria-hidden="true">6.3.</strong> Pushbutton UART</a></li><li class="chapter-item expanded "><a href="../exemple/wave_gen_sinus/wave_gen_sinus.html"><strong aria-hidden="true">6.4.</strong> Sinus generator</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Project SA4 STM32 - Traitement du son</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://gitlab.ensta-bretagne.fr/roudauta/depot-STM32-Traitement-Son" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-gitlab"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="filtrage"><a class="header" href="#filtrage">Filtrage</a></h1>
<p>Comme on peut le constater sur l'image suivante, un signal <em>PDM</em> a une fréquence d'échantillonnage beaucoup plus importante qu'un signal <em>PCM</em>.</p>
<p><img src="./img/pdm_pcm.png" alt="" /></p>
<p>Réaliser une décimation pour réduire cette fréquence et convertir notre signal <em>PCM</em> permet d'obtenir un signal audible, mais pas parfait. Dans un premier temps on peut constater qu'il y aura une perte de certaine information, mais le principal problème et la conservation de certaine de ces hautes fréquences qui peuvent causer du bruit ou encore une qualité type talkie-walkie. </p>
<p>L'objectif de cette partie consiste donc à obtenir un signal de meilleure qualité, mais pour ce faire, il est important de comprendre correctement les étapes pour procéder au filtrage à l'aide de Matlab.</p>
<h2 id="les-effets-dun-signal-pdm"><a class="header" href="#les-effets-dun-signal-pdm">Les effets d'un signal PDM</a></h2>
<p>C'est étapes ne seront pas directement liées à notre projet, nous allons partir d'un enregistrement audio et nous allons le convertir en <em>PDM</em> pour comprendre les effets de cette modulation et comment les réduire.</p>
<h3 id="lecture-dun-signal-audio"><a class="header" href="#lecture-dun-signal-audio">Lecture d'un signal audio</a></h3>
<p>Dans un premier temps nous devons lire ce signal audio. On pourra également extraire certaines données essentielles qui pourront nous servir pour la suite.</p>
<pre><code class="language-c">[x, fs] = audioread('bond.wav');

Ts = 1/fs;
N = length(x);
t = [0:Ts:(N-1)*Ts];
duree = N/fs
</code></pre>
<p><img src="./img/bond_temp.png" alt="" /></p>
<h3 id="conversion-du-signal-audio-vers-un-signal-pdm"><a class="header" href="#conversion-du-signal-audio-vers-un-signal-pdm">Conversion du signal audio vers un signal PDM</a></h3>
<p>Il est nécessaire d'échantilloner à nouveau notre signal. La fréquence actuelle ne correspond pas à celle que l'on utilise dans notre projet, une fréquence de <em>3.072MHz</em>.</p>
<pre><code class="language-c">fs_new = 3.072e6; 

x_resampled = resample(x, fs_new, fs);
</code></pre>
<br>
<p>Une fois que l'on a la bonne fréquence, on peut réaliser une modulation PDM à l'aide d'une fonction que nous avons réalisée, cette fonction est inspirée de l'algorithme donné par <a href="https://en.wikipedia.org/wiki/Pulse-density_modulation">Wikipédia</a>. </p>
<pre><code class="language-c">function result = modulation_PDM(s, qe)
    s_mod = zeros(1, length(s));
    for i = 1:length(s)
        qe = qe + s(i);

        if qe &gt; 0 
            s_mod(i) = 1;
        else
            s_mod(i) = -1;
        end
        qe = qe - s_mod(i);
    end
    result = s_mod;
 end 
</code></pre>
<pre><code class="language-c">x_mod = modulation_PDM(x_resampled, 0);
</code></pre>
<p><img src="./img/pdm.png" alt="" /></p>
<ul>
<li>Orange → Signal PDM</li>
<li>Bleu → Signal Audio sur-échantillonné</li>
</ul>
<p>On remarque facilement que le signal PDM a majoritairement des hautes fréquences comparé au signal audio sur-échantillonné. De plus, on ne reconnaît même plus notre allure temporelle que nous avions précédemment.</p>
<h3 id="traitement-du-signal-pdm"><a class="header" href="#traitement-du-signal-pdm">Traitement du signal PDM</a></h3>
<p>Dans notre projet, nous avons utilisé une décimation pour réaliser la conversion PDM → PCM. Ici, on va optimiser ce processus que nous avons simplifié, à l'aide d'un filtre passe-bas. On remarque au final que nous allons réaliser ce qui est préconisé par STM (cf <a href="../conversion/conversion.html">conversion</a>). </p>
<p>Pour ce faire, on va appliquer un filtre passe-bas à moyenne glissante sur soixante-quatre points, ainsi qu'un sous échantillonnage avec un facteur de 64, ce qui correspond également au facteur décimation que nous avons utilisé dans notre projet.</p>
<p>$$ \frac{3.072MHz}{64} = 48kHz$$</p>
<p>On procède donc au filtrage de la manière suivante:</p>
<pre><code class="language-c">nb_points = 64;
ech_factor = 64;

filtre = ones(1, nb_points)/ech_factor;
x_filtered = filter(filtre, 1, x_mod);
</code></pre>
<p><img src="img/pdm_trait%C3%A9.png" alt="" /></p>
<ul>
<li>Orange → Signal PDM traité</li>
<li>Bleu → Signal Audio</li>
</ul>
<p>Grâce au filtre nous avons retrouvé l'allure de notre signal audio, mais la représentation fréquentielle démontre que nous avons toujours une présence importante des hautes fréquences. Comme expliqué plus tôt, ce sont les hautes fréquences obtenues à la suite de notre décimation qui réduisent la qualité de notre signal. On constate donc que ces dernières sont bel et bien présentes, l'objectif va donc être de les filtrer.</p>
<h3 id="filtrage-dun-signal-pdm"><a class="header" href="#filtrage-dun-signal-pdm">Filtrage d'un signal PDM</a></h3>
<p>À présent l'objectif est donc de supprimer les composantes fréquentielles haute-fréquence du signal. Pour ce faire, nous allons utiliser un filtre passe-bas.</p>
<h4 id="design-du-filtre"><a class="header" href="#design-du-filtre">Design du filtre</a></h4>
<p>Nous allons utiliser les données précédemment obtenues suite aux analyses pour designer notre filtre à l'aide de l'outil Matlab: <em>filterDesigner</em></p>
<p><img src="./img/fda.png" alt="" /></p>
<p>Cet outil nous aide dans la création du filtre pour vérifier si nos paramètres sont bons, mais également pour générer le code associé. Ce code nous permettra de filtrer notre signal <em>PDM</em></p>
<pre><code class="language-c">function coeffs_fir = createFIRFilter

Fs = 48000; 

Fpass = 5000;         
Fstop = 6000;           
Dpass = 0.057501127785; 
Dstop = 0.1;           
dens  = 20;          

[N, Fo, Ao, W] = firpmord([Fpass, Fstop]/(Fs/2), [1 0], [Dpass, Dstop]);

b  = firpm(N, Fo, Ao, W, {dens});
Hd = dfilt.dffir(b);
coeffs_fir=Hd.Numerator;
</code></pre>
<h4 id="utilisation-du-filtre"><a class="header" href="#utilisation-du-filtre">Utilisation du filtre</a></h4>
<p>Le principe est le même qu'avec le premier filtre, mais cette fois-ci il faut faire appel à notre fonction précédemment créée</p>
<pre><code class="language-c">fir_filter = createFIRFilter();
x_filtered_2 = filter(fir_filter, 1, x_filtered);
</code></pre>
<p><img src="./img/pdm_filtre.png" alt="" /></p>
<ul>
<li>Orange → Signal PDM traité</li>
<li>Bleu → Signal Audio</li>
<li>Jaune → Signal PDM filtré</li>
</ul>
<p>On remarque facilement les effets du filtre, nous avons supprimé les hautes fréquences provenant du signal PDM tout en préservant l'allure du signal audio. Si on écoute les trois audios, une nette amélioration est à noter. </p>
<h2 id="filtrage-de-notre-signal-pcm"><a class="header" href="#filtrage-de-notre-signal-pcm">Filtrage de notre signal PCM</a></h2>
<p>Maintenant que nous avons calculé un filtre qui permet de filtrer les hautes fréquences provenant de notre signal PDM, nous pouvons reproduire ce code dans notre projet en utilisant les paramètres donnés par matlab. L'objectif est donc de réaliser le schéma suivant :</p>
<p><img src="./img/fir.png" alt="" />
<img src="./img/fir2.png" alt="" /></p>
<p>Pour ce faire nous pouvons réaliser une fonction qui va nous permettre de calculer les coefficients du filtre FIR et une autre pour appliquer le filtre sur chaque échantillon PCM.</p>
<pre><code class="language-c">#define FILTER_CUTOFF_FREQUENCY 6000
#define FILTER_SAMPLING_FREQUENCY 48000
#define FILTER_NB_COEF 64

void calcFIR(float* FIRcoef, int nbCoef, float fc, float fe){
    float normalizedFc = 2.0f * PI * fc / fe;
    float sinc, hamming;
    for (int coefN = 0; coefN &lt; nbCoef; coefN++) {
        if (coefN == (nbCoef-1)/2) {
        	FIRcoef[coefN] = normalizedFc / PI;
        } else {
            sinc = sinf(normalizedFc * (coefN - (nbCoef-1)/2)) / (PI * (coefN - (nbCoef-1)/2));
            hamming = 0.54f - 0.46f * cosf(2.0f * PI * coefN / (nbCoef-1));
            FIRcoef[coefN] = sinc * hamming;
        }
    }
}

void FIR(float* FIRcoef, int nbCoef, uint8_t* pcmData){
	for (int pcmIndex = 0; pcmIndex &lt; PCM_NB_SAMPLE; pcmIndex++){
		float sum = 0;
		for(int nCoef = nbCoef; nCoef &lt; nbCoef; nCoef++){
			sum += pcmData[pcmIndex+nCoef] * FIRcoef[nCoef];
		}
		pcmData[pcmIndex] = (uint32_t)sum;
	}
}
</code></pre>
<p>Un appel à nos fonctions nous permettront d'obtenir notre signal PCM filtré, les hautes fréquences seront donc retirées.</p>
<pre><code class="language-c">float FIRcoef[FILTER_NB_COEF];
calcFIR(FIRcoef, FILTER_NB_COEF, FILTER_CUTOFF_FREQUENCY, FILTER_SAMPLING_FREQUENCY);
FIR(FIRcoef, FILTER_NB_COEF, pcmData);
</code></pre>
<blockquote>
<p><em>Il est important de noter que nous n'avons pas pu tester cette dernière version de notre projet</em></p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../diffusion/diffusion.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../exemple/exemple.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../diffusion/diffusion.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../exemple/exemple.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </div>
    </body>
</html>
